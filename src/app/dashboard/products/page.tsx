"use client"

import {
  useState,
  useEffect,
  useMemo,
  createContext,
  useContext,
  useRef,
} from "react"
import dynamic from "next/dynamic"
import {
  Card,
  CardHeader,
  CardBody,
  Table,
  TableHeader,
  TableColumn,
  TableBody,
  TableRow,
  TableCell,
  Chip,
  Button,
  Input,
  Select,
  SelectItem,
  Pagination,
  Modal,
  ModalContent,
  ModalHeader,
  ModalBody,
  ModalFooter,
  useDisclosure,
  Checkbox,
  Dropdown,
  DropdownTrigger,
  DropdownMenu,
  DropdownItem,
  Textarea,
  Form,
  Divider,
} from "@nextui-org/react"
import {
  Package,
  Search,
  Filter,
  Plus,
  Upload,
  Download,
  Edit2,
  Trash2,
  MoreVertical,
  RefreshCw,
  CheckSquare,
  Square,
  X,
  CheckCircle,
  XCircle,
} from "lucide-react"
// Âä®ÊÄÅÂØºÂÖ•‰ª•ÈÅøÂÖç hydration ÈîôËØØ
const RealProgressUpload = dynamic(
  () =>
    import("@/components/ui/real-progress-upload").then(mod => ({
      default: mod.RealProgressUpload,
    })),
  {
    ssr: false,
    loading: () => <div>Âä†ËΩΩ‰∏≠...</div>,
  }
)
import { ConfirmModal } from "@/components/ui/confirm-modal"
import { ProductForm } from "@/components/product"
import ProductSearchBar, {
  SearchFilters,
} from "@/components/product/product-search-bar"
// Âä®ÊÄÅÂØºÂÖ• EmptyState ‰ª•ÈÅøÂÖç hydration ÈîôËØØ
const EmptyState = dynamic(
  () =>
    import("@/components/ui/empty-state").then(mod => ({
      default: mod.EmptyState,
    })),
  {
    ssr: false,
    loading: () => (
      <div className="flex items-center justify-center py-12">Âä†ËΩΩ‰∏≠...</div>
    ),
  }
)
import { useNotifications } from "@/stores/app"
import { getAuthHeaders } from "@/lib/auth"
import {
  API_ROUTES,
  buildApiUrl,
  apiGet,
  apiPost,
  apiPut,
  apiDelete,
} from "@/lib/api"

// Context for template selection
const TemplateContext = createContext<string>("")

interface Product {
  _id: string
  templateId: string
  name: string
  brand: string
  productCode?: string
  boxCode?: string
  productType?: string
  packageType?: string
  specifications?: {
    circumference?: number
    length?: string
    packageQuantity?: number
  }
  launchDate?: string
  chemicalContent?: {
    tarContent?: number
    nicotineContent?: number
    carbonMonoxideContent?: number
  }
  appearance?: {
    color?: string
  }
  company?: string
  features?: {
    hasPop?: boolean
  }
  pricing?: {
    priceCategory?: string
    retailPrice?: number
    unit?: string
    companyPrice?: number
  }
  wholesale?: {
    name?: string
    price?: number
  }
  category?: string
  keywords: string[]
  isActive: boolean
  createdAt: string
  updatedAt: string
}

interface ProductTemplate {
  id: string
  name: string
  description: string
  category: string
  statistics: {
    productCount: number
    matchingTaskCount: number
  }
  isActive: boolean
  isDefault: boolean
}

interface ProductsResponse {
  success: boolean
  data: {
    products: Product[]
    pagination: {
      page: number
      limit: number
      total: number
      pages: number
      hasNext: boolean
      hasPrev: boolean
    }
  }
}

export default function ProductsPage() {
  const [products, setProducts] = useState<Product[]>([])
  const [loading, setLoading] = useState(true)
  const [page, setPage] = useState(1)
  const [limit, setLimit] = useState(10) // ÈªòËÆ§10Êù°ÔºåÊîπ‰∏∫ÂèØÂèò
  const [total, setTotal] = useState(0)

  const [filters, setFilters] = useState({})
  const [selectedKeys, setSelectedKeys] = useState(new Set<string>())
  const [batchLoading, setBatchLoading] = useState(false)
  const [editingProduct, setEditingProduct] = useState<Product | null>(null)
  const [allProductIds, setAllProductIds] = useState<string[]>([])
  const [allIdsLoading, setAllIdsLoading] = useState(false)

  // Ê®°ÊùøÁõ∏ÂÖ≥Áä∂ÊÄÅ
  const [templates, setTemplates] = useState<ProductTemplate[]>([])
  const [selectedTemplateId, setSelectedTemplateId] = useState<string>("")
  const [templatesLoading, setTemplatesLoading] = useState(true)

  // ÂàÜÈ°µÂ§ßÂ∞èÈÄâÈ°π
  const pageSizeOptions = [
    { label: "10Êù°/È°µ", value: 10 },
    { label: "20Êù°/È°µ", value: 20 },
    { label: "50Êù°/È°µ", value: 50 },
    { label: "100Êù°/È°µ", value: 100 },
  ]

  // ÈÄöÁü•Á≥ªÁªü
  const notifications = useNotifications()

  // useEffect hooks - ÂøÖÈ°ªÂú®ÁªÑ‰ª∂È°∂ÈÉ®
  useEffect(() => {
    fetchTemplates()
  }, [])

  useEffect(() => {
    if (selectedTemplateId) {
      fetchProducts()
    }
  }, [page, limit, selectedTemplateId])

  useEffect(() => {
    if (selectedTemplateId) {
      fetchAllProductIds()
    }
  }, [selectedTemplateId])

  // Ê®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
  const {
    isOpen: isUploadOpen,
    onOpen: onUploadOpen,
    onClose: onUploadClose,
  } = useDisclosure()
  const {
    isOpen: isDeleteOpen,
    onOpen: onDeleteOpen,
    onClose: onDeleteClose,
  } = useDisclosure()
  const {
    isOpen: isBatchDeleteOpen,
    onOpen: onBatchDeleteOpen,
    onClose: onBatchDeleteClose,
  } = useDisclosure()
  const {
    isOpen: isEditOpen,
    onOpen: onEditOpen,
    onClose: onEditClose,
  } = useDisclosure()
  const {
    isOpen: isCreateOpen,
    onOpen: onCreateOpen,
    onClose: onCreateClose,
  } = useDisclosure()
  const [deletingId, setDeletingId] = useState<string | null>(null)

  // ËÆ°ÁÆóÈÄâ‰∏≠ÁöÑÂïÜÂìÅ
  const selectedProducts = useMemo(() => {
    return Array.from(selectedKeys)
      .map(key => products.find(product => product._id === key))
      .filter(Boolean) as Product[]
  }, [selectedKeys, products])

  // ÊòØÂê¶ÂÖ®ÈÄâÔºàÂΩìÂâçÈ°µÔºâ
  const isPageAllSelected = useMemo(() => {
    return (
      products.length > 0 &&
      products.every(product => selectedKeys.has(product._id))
    )
  }, [selectedKeys, products])

  // ÊòØÂê¶ÂÖ®ÈÄâÔºàÊâÄÊúâÈ°µÔºâ
  const isAllSelected = useMemo(() => {
    return (
      allProductIds.length > 0 &&
      allProductIds.every(id => selectedKeys.has(id))
    )
  }, [selectedKeys, allProductIds])

  // ÊòØÂê¶ÈÉ®ÂàÜÈÄâ‰∏≠
  const isIndeterminate = useMemo(() => {
    return selectedKeys.size > 0 && !isAllSelected
  }, [selectedKeys.size, isAllSelected])

  // Ëé∑ÂèñÊ®°ÊùøÂàóË°®
  const fetchTemplates = async () => {
    try {
      setTemplatesLoading(true)
      const response = await fetch(buildApiUrl(API_ROUTES.TEMPLATES.OPTIONS), {
        headers: getAuthHeaders(),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const data = await response.json()
      const templateList = data.data.templates || []
      setTemplates(templateList)

      // Â¶ÇÊûúÊ≤°ÊúâÈÄâ‰∏≠ÁöÑÊ®°Êùø‰∏îÊúâÊ®°ÊùøÔºåÈÄâÊã©ÈªòËÆ§Ê®°ÊùøÊàñÁ¨¨‰∏Ä‰∏™Ê®°Êùø
      if (!selectedTemplateId && templateList.length > 0) {
        const defaultTemplate = templateList.find(
          (t: ProductTemplate) => t.isDefault
        )
        const templateId = defaultTemplate?.id || templateList[0].id
        setSelectedTemplateId(templateId)
      }
    } catch (error) {
      console.error("‚ùå Ëé∑ÂèñÊ®°ÊùøÂàóË°®Â§±Ë¥•:", error)
      notifications.error("Âä†ËΩΩÂ§±Ë¥•", "Êó†Ê≥ïËé∑ÂèñÊ®°ÊùøÂàóË°®")
    } finally {
      setTemplatesLoading(false)
    }
  }

  // Â∏¶filtersÂèÇÊï∞ÁöÑÊï∞ÊçÆËé∑ÂèñÂáΩÊï∞
  const fetchProductsWithFilters = async (searchFilters: any = {}) => {
    if (!selectedTemplateId) {
      setLoading(false)
      return
    }

    try {
      setLoading(true)
      console.log(
        `üî• Ëé∑Âèñ‰∫ßÂìÅÊï∞ÊçÆ - È°µÁ†Å: ${page}, Ê®°Êùø: ${selectedTemplateId}, ËøáÊª§Âô®:`,
        searchFilters
      )

      // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIÈÖçÁΩÆ
      const baseUrl = buildApiUrl(API_ROUTES.PRODUCTS.LIST)
      const url = new URL(baseUrl)
      url.searchParams.set("templateId", selectedTemplateId)
      url.searchParams.set("page", page.toString())
      url.searchParams.set("limit", limit.toString())

      // Ê∑ªÂä†ËøáÊª§Âô®ÂèÇÊï∞
      Object.entries(searchFilters).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== "") {
          if (typeof value === "object" && !Array.isArray(value)) {
            // Â§ÑÁêÜËåÉÂõ¥Á±ªÂûãÁöÑËøáÊª§Âô®
            Object.entries(value).forEach(([subKey, subValue]) => {
              if (subValue !== undefined && subValue !== null) {
                url.searchParams.set(`${key}.${subKey}`, subValue.toString())
              }
            })
          } else {
            url.searchParams.set(key, value.toString())
          }
        }
      })

      const response = await fetch(url.toString(), {
        method: "GET",
        headers: getAuthHeaders(),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const data: ProductsResponse = await response.json()
      setProducts(data.data.products)
      setTotal(data.data.pagination.total)
      console.log("‚úÖ ‰∫ßÂìÅÊï∞ÊçÆËé∑ÂèñÊàêÂäü", {
        count: data.data.products.length,
        total: data.data.pagination.total,
      })
    } catch (error) {
      console.error("‚ùå ‰∫ßÂìÅÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•:", error)
      notifications.error(
        "Ëé∑Âèñ‰∫ßÂìÅÊï∞ÊçÆÂ§±Ë¥•",
        error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"
      )
      setProducts([])
      setTotal(0)
    } finally {
      setLoading(false)
    }
  }

  // ÁÆÄÂçïÁõ¥Êé•ÁöÑÊï∞ÊçÆËé∑ÂèñÂáΩÊï∞
  const fetchProducts = async () => {
    if (!selectedTemplateId) {
      setLoading(false)
      return
    }

    try {
      setLoading(true)
      console.log(
        `üî• Ëé∑Âèñ‰∫ßÂìÅÊï∞ÊçÆ - È°µÁ†Å: ${page}, Ê®°Êùø: ${selectedTemplateId}, ËøáÊª§Âô®:`,
        filters
      )

      // ‰ΩøÁî®Áªü‰∏ÄÁöÑAPIÈÖçÁΩÆ
      const baseUrl = buildApiUrl(API_ROUTES.PRODUCTS.LIST)
      const url = new URL(baseUrl)
      url.searchParams.set("templateId", selectedTemplateId)
      url.searchParams.set("page", page.toString())
      url.searchParams.set("limit", limit.toString())

      // Ê∑ªÂä†ËøáÊª§Âô®ÂèÇÊï∞
      Object.entries(filters).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== "") {
          if (typeof value === "object" && !Array.isArray(value)) {
            // Â§ÑÁêÜËåÉÂõ¥Á±ªÂûãÁöÑËøáÊª§Âô®
            Object.entries(value).forEach(([subKey, subValue]) => {
              if (subValue !== undefined && subValue !== null) {
                url.searchParams.set(`${key}.${subKey}`, subValue.toString())
              }
            })
          } else {
            url.searchParams.set(key, value.toString())
          }
        }
      })

      console.log(`üîó ËØ∑Ê±ÇURL: ${url.toString()}`)

      const response = await fetch(url.toString(), {
        headers: getAuthHeaders(),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const data: ProductsResponse = await response.json()
      console.log("‚úÖ ‰∫ßÂìÅÊï∞ÊçÆËé∑ÂèñÊàêÂäü:", data)

      setProducts(data.data.products)
      setTotal(data.data.pagination.total)
    } catch (error: any) {
      console.error("‚ùå ‰∫ßÂìÅÊï∞ÊçÆËé∑ÂèñÂ§±Ë¥•:", error)
      console.error("‚ùå ÈîôËØØËØ¶ÊÉÖ:", error?.message)
      console.error("‚ùå ÈîôËØØÂ†ÜÊ†à:", error?.stack)

      // Âú®È°µÈù¢‰∏ä‰πüÊòæÁ§∫ÈîôËØØ
      notifications.error(
        "Âä†ËΩΩÂ§±Ë¥•",
        `Ëé∑Âèñ‰∫ßÂìÅÊï∞ÊçÆÂ§±Ë¥•: ${error?.message || "Êú™Áü•ÈîôËØØ"}`
      )

      setProducts([])
      setTotal(0)
    } finally {
      setLoading(false)
    }
  }

  // Âà†Èô§‰∫ßÂìÅ
  const deleteProduct = async (id: string) => {
    try {
      const response = await fetch(
        buildApiUrl(API_ROUTES.PRODUCTS.DELETE(id)),
        {
          method: "DELETE",
          headers: getAuthHeaders(),
        }
      )

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      console.log("‚úÖ ‰∫ßÂìÅÂà†Èô§ÊàêÂäü")
      notifications.success("Âà†Èô§ÊàêÂäü", "ÂïÜÂìÅÂ∑≤ÊàêÂäüÂà†Èô§")
      if (selectedTemplateId) {
        await fetchProducts() // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
        await fetchAllProductIds() // Êõ¥Êñ∞ÂÖ®ÈÄâÂïÜÂìÅÊï∞Èáè
      }
    } catch (error) {
      console.error("‚ùå ‰∫ßÂìÅÂà†Èô§Â§±Ë¥•:", error)
      notifications.error(
        "Âà†Èô§Â§±Ë¥•",
        error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"
      )
    }
  }

  // ÊâπÈáèÂà†Èô§ÂïÜÂìÅ
  const batchDeleteProducts = async (ids: string[]) => {
    try {
      setBatchLoading(true)

      const response = await fetch(
        buildApiUrl(API_ROUTES.PRODUCTS.HARD_DELETE),
        {
          method: "POST",
          headers: getAuthHeaders(),
          body: JSON.stringify({
            ids: ids,
            templateId: selectedTemplateId,
          }),
        }
      )

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      console.log("‚úÖ ÊâπÈáèÂà†Èô§ÊàêÂäü")
      notifications.success("ÊâπÈáèÂà†Èô§ÊàêÂäü", `Â∑≤ÊàêÂäüÂà†Èô§ ${ids.length} ‰∏™ÂïÜÂìÅ`)
      setSelectedKeys(new Set()) // Ê∏ÖÁ©∫ÈÄâÊã©
      if (selectedTemplateId) {
        await fetchProducts() // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
        await fetchAllProductIds() // Êõ¥Êñ∞ÂÖ®ÈÄâÂïÜÂìÅÊï∞Èáè
      }
    } catch (error) {
      console.error("‚ùå ÊâπÈáèÂà†Èô§Â§±Ë¥•:", error)
      notifications.error(
        "ÊâπÈáèÂà†Èô§Â§±Ë¥•",
        error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"
      )
    } finally {
      setBatchLoading(false)
    }
  }

  // ÊâπÈáèÊìç‰ΩúÂïÜÂìÅÔºàÂêØÁî®/Á¶ÅÁî®Ôºâ
  const batchOperation = async (action: "activate" | "deactivate") => {
    try {
      setBatchLoading(true)
      const ids = Array.from(selectedKeys)

      const response = await fetch(buildApiUrl(API_ROUTES.PRODUCTS.BATCH), {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify({
          operation: action,
          productIds: ids,
          templateId: selectedTemplateId,
        }),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const actionText = action === "activate" ? "ÂêØÁî®" : "Á¶ÅÁî®"
      console.log(`‚úÖ ÊâπÈáè${actionText}ÊàêÂäü`)
      notifications.success(
        `ÊâπÈáè${actionText}ÊàêÂäü`,
        `Â∑≤ÊàêÂäü${actionText} ${ids.length} ‰∏™ÂïÜÂìÅ`
      )
      setSelectedKeys(new Set()) // Ê∏ÖÁ©∫ÈÄâÊã©
      if (selectedTemplateId) {
        await fetchProducts() // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
        await fetchAllProductIds() // Êõ¥Êñ∞ÂÖ®ÈÄâÂïÜÂìÅÊï∞Èáè
      }
    } catch (error) {
      const actionText = action === "activate" ? "ÂêØÁî®" : "Á¶ÅÁî®"
      console.error(`‚ùå ÊâπÈáè${actionText}Â§±Ë¥•:`, error)
      notifications.error(
        `ÊâπÈáè${actionText}Â§±Ë¥•`,
        error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"
      )
    } finally {
      setBatchLoading(false)
    }
  }

  // ÁºñËæëÂïÜÂìÅ
  const updateProduct = async (productData: Partial<Product>) => {
    if (!editingProduct) return

    try {
      const response = await fetch(
        buildApiUrl(API_ROUTES.PRODUCTS.UPDATE(editingProduct._id)),
        {
          method: "PUT",
          headers: getAuthHeaders(),
          body: JSON.stringify(productData),
        }
      )

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      console.log("‚úÖ ÂïÜÂìÅÊõ¥Êñ∞ÊàêÂäü")
      notifications.success("Êõ¥Êñ∞ÊàêÂäü", "ÂïÜÂìÅ‰ø°ÊÅØÂ∑≤ÊàêÂäüÊõ¥Êñ∞")
      setEditingProduct(null)
      onEditClose()
      if (selectedTemplateId) {
        await fetchProducts() // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
        await fetchAllProductIds() // Êõ¥Êñ∞ÂÖ®ÈÄâÂïÜÂìÅÊï∞Èáè
      }
    } catch (error) {
      console.error("‚ùå ÂïÜÂìÅÊõ¥Êñ∞Â§±Ë¥•:", error)
      notifications.error(
        "Êõ¥Êñ∞Â§±Ë¥•",
        error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"
      )
    }
  }

  // ÂàõÂª∫ÂïÜÂìÅ
  const createProduct = async (
    productData: Omit<Product, "_id" | "createdAt" | "updatedAt">
  ) => {
    try {
      const response = await fetch(buildApiUrl(API_ROUTES.PRODUCTS.CREATE), {
        method: "POST",
        headers: getAuthHeaders(),
        body: JSON.stringify(productData),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      console.log("‚úÖ ÂïÜÂìÅÂàõÂª∫ÊàêÂäü")
      notifications.success("ÂàõÂª∫ÊàêÂäü", "Êñ∞ÂïÜÂìÅÂ∑≤ÊàêÂäüÂàõÂª∫")
      onCreateClose()
      if (selectedTemplateId) {
        await fetchProducts() // ÈáçÊñ∞Ëé∑ÂèñÊï∞ÊçÆ
        await fetchAllProductIds() // Êõ¥Êñ∞ÂÖ®ÈÄâÂïÜÂìÅÊï∞Èáè
      }
    } catch (error) {
      console.error("‚ùå ÂïÜÂìÅÂàõÂª∫Â§±Ë¥•:", error)
      notifications.error(
        "ÂàõÂª∫Â§±Ë¥•",
        error instanceof Error ? error.message : "Êú™Áü•ÈîôËØØ"
      )
    }
  }

  // Â∏¶filtersÂèÇÊï∞ÁöÑËé∑ÂèñÊâÄÊúâÂïÜÂìÅIDÂáΩÊï∞
  const fetchAllProductIdsWithFilters = async (searchFilters: any = {}) => {
    if (!selectedTemplateId) {
      setAllProductIds([])
      return
    }

    try {
      setAllIdsLoading(true)

      const baseUrl = buildApiUrl(API_ROUTES.PRODUCTS.ALL_IDS)
      const url = new URL(baseUrl)
      url.searchParams.set("templateId", selectedTemplateId)

      // Ê∑ªÂä†ËøáÊª§Âô®ÂèÇÊï∞
      Object.entries(searchFilters).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== "") {
          if (typeof value === "object" && !Array.isArray(value)) {
            // Â§ÑÁêÜËåÉÂõ¥Á±ªÂûãÁöÑËøáÊª§Âô®
            Object.entries(value).forEach(([subKey, subValue]) => {
              if (subValue !== undefined && subValue !== null) {
                url.searchParams.set(`${key}.${subKey}`, subValue.toString())
              }
            })
          } else {
            url.searchParams.set(key, value.toString())
          }
        }
      })

      const response = await fetch(url.toString(), {
        method: "GET",
        headers: getAuthHeaders(),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const data = await response.json()
      setAllProductIds(data.data?.ids || [])
      console.log("‚úÖ ÂïÜÂìÅIDËé∑ÂèñÊàêÂäü", {
        count: data.data?.ids?.length || 0,
      })
    } catch (error) {
      console.error("‚ùå ÂïÜÂìÅIDËé∑ÂèñÂ§±Ë¥•:", error)
      setAllProductIds([])
    } finally {
      setAllIdsLoading(false)
    }
  }

  // Ëé∑ÂèñÊâÄÊúâÂïÜÂìÅIDÔºàÁî®‰∫éÂÖ®ÈÄâÔºâ
  const fetchAllProductIds = async () => {
    if (!selectedTemplateId) {
      setAllProductIds([])
      return
    }

    try {
      setAllIdsLoading(true)

      const baseUrl = buildApiUrl(API_ROUTES.PRODUCTS.ALL_IDS)
      const url = new URL(baseUrl)
      url.searchParams.set("templateId", selectedTemplateId)

      // Ê∑ªÂä†ËøáÊª§Âô®ÂèÇÊï∞
      Object.entries(filters).forEach(([key, value]) => {
        if (value !== undefined && value !== null && value !== "") {
          if (typeof value === "object" && !Array.isArray(value)) {
            // Â§ÑÁêÜËåÉÂõ¥Á±ªÂûãÁöÑËøáÊª§Âô®
            Object.entries(value).forEach(([subKey, subValue]) => {
              if (subValue !== undefined && subValue !== null) {
                url.searchParams.set(`${key}.${subKey}`, subValue.toString())
              }
            })
          } else {
            url.searchParams.set(key, value.toString())
          }
        }
      })

      const response = await fetch(url.toString(), {
        headers: getAuthHeaders(),
      })

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`)
      }

      const data = await response.json()
      setAllProductIds(data.data.ids)
    } catch (error: any) {
      console.error("‚ùå Ëé∑ÂèñÂïÜÂìÅIDÂàóË°®Â§±Ë¥•:", error)
      notifications.error(
        "Ëé∑ÂèñÂ§±Ë¥•",
        `Ëé∑ÂèñÂïÜÂìÅIDÂàóË°®Â§±Ë¥•: ${error?.message || "Êú™Áü•ÈîôËØØ"}`
      )
      setAllProductIds([])
    } finally {
      setAllIdsLoading(false)
    }
  }

  // ÈÄâÊã©Â§ÑÁêÜ - ÂΩìÂâçÈ°µÂÖ®ÈÄâ
  const togglePageSelection = () => {
    if (isPageAllSelected) {
      // ÂèñÊ∂àÂΩìÂâçÈ°µÈÄâÊã©
      const newSelectedKeys = new Set(selectedKeys)
      products.forEach(product => newSelectedKeys.delete(product._id))
      setSelectedKeys(newSelectedKeys)
    } else {
      // ÈÄâÊã©ÂΩìÂâçÈ°µ
      const newSelectedKeys = new Set(selectedKeys)
      products.forEach(product => newSelectedKeys.add(product._id))
      setSelectedKeys(newSelectedKeys)
    }
  }

  // ÂÖ®ÈÄâÊâÄÊúâÈ°µ
  const selectAllPages = () => {
    if (isAllSelected) {
      setSelectedKeys(new Set())
    } else {
      setSelectedKeys(new Set(allProductIds))
    }
  }

  const toggleSelection = (id: string) => {
    const newSelectedKeys = new Set(selectedKeys)
    if (newSelectedKeys.has(id)) {
      newSelectedKeys.delete(id)
    } else {
      newSelectedKeys.add(id)
    }
    setSelectedKeys(newSelectedKeys)
  }

  // ÊêúÁ¥¢Â§ÑÁêÜ
  const handleSearch = () => {
    setPage(1) // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
    setSelectedKeys(new Set()) // Ê∏ÖÁ©∫ÈÄâÊã©
    if (selectedTemplateId) {
      fetchProducts()
      fetchAllProductIds() // ÈáçÊñ∞Ëé∑ÂèñIDÂàóË°®
    }
  }

  // Â§ÑÁêÜÂàÜÈ°µÂ§ßÂ∞èÊîπÂèò
  const handleLimitChange = (newLimit: number) => {
    setLimit(newLimit)
    setPage(1) // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
    setSelectedKeys(new Set()) // Ê∏ÖÁ©∫ÈÄâÊã©
  }

  // Â§ÑÁêÜÂà†Èô§
  const handleDelete = (id: string) => {
    setDeletingId(id)
    onDeleteOpen()
  }

  const confirmDelete = async () => {
    if (deletingId) {
      await deleteProduct(deletingId)
      setDeletingId(null)
    }
    onDeleteClose()
  }

  // Â§ÑÁêÜÊâπÈáèÂà†Èô§
  const handleBatchDelete = () => {
    if (selectedKeys.size === 0) return
    onBatchDeleteOpen()
  }

  const confirmBatchDelete = async () => {
    const ids = Array.from(selectedKeys)
    await batchDeleteProducts(ids)
    onBatchDeleteClose()
  }

  // Â§ÑÁêÜÁºñËæë
  const handleEdit = (product: Product) => {
    setEditingProduct(product)
    onEditOpen()
  }

  // Â§ÑÁêÜÊñ∞Â¢û
  const handleCreate = () => {
    onCreateOpen()
  }

  // ‰∏ä‰º†ÊàêÂäüÂõûË∞É
  const handleUploadSuccess = async (result: any) => {
    console.log("üéâ ‰∏ä‰º†ÊàêÂäüÔºåÂà∑Êñ∞Êï∞ÊçÆ", result)

    if (selectedTemplateId) {
      await fetchProducts() // ÈáçÊñ∞Ëé∑ÂèñÂïÜÂìÅÂàóË°®
      await fetchAllProductIds() // ÈáçÊñ∞Ëé∑ÂèñIDÂàóË°®
    }

    // ÈÄöÁü•‰ø°ÊÅØÂ∑≤Âú®‰∏ä‰º†ÁªÑ‰ª∂‰∏≠Â§ÑÁêÜÔºåËøôÈáå‰∏çÈáçÂ§çÊòæÁ§∫
  }

  const renderStatusChip = (isActive: boolean) => {
    return (
      <Chip color={isActive ? "success" : "default"} variant="flat" size="sm">
        {isActive ? "ÂêØÁî®" : "Á¶ÅÁî®"}
      </Chip>
    )
  }

  const renderActions = (product: Product) => {
    return (
      <div className="flex items-center gap-1">
        <Button
          isIconOnly
          size="sm"
          variant="light"
          color="primary"
          onPress={() => handleEdit(product)}
          className="h-8 w-8 min-w-8"
        >
          <Edit2 className="h-4 w-4" />
        </Button>
        <Button
          isIconOnly
          size="sm"
          variant="light"
          color="danger"
          onPress={() => handleDelete(product._id)}
          className="h-8 w-8 min-w-8"
        >
          <Trash2 className="h-4 w-4" />
        </Button>
      </div>
    )
  }

  return (
    <TemplateContext.Provider value={selectedTemplateId}>
      <div className="space-y-6">
        {/* È°µÈù¢Ê†áÈ¢ò */}
        <div className="flex items-center justify-between">
          <div>
            <h1 className="text-2xl font-bold">ÂïÜÂìÅÁÆ°ÁêÜ</h1>
            <p className="text-default-500">
              ÁÆ°ÁêÜÂïÜÂìÅ‰ø°ÊÅØÔºåÊîØÊåÅÊâπÈáèÂØºÂÖ•ÂíåÊï∞ÊçÆÂàÜÊûê
            </p>
          </div>
          <div className="flex gap-2">
            <Button
              variant="flat"
              startContent={<RefreshCw className="h-4 w-4" />}
              onClick={() => selectedTemplateId && fetchProducts()}
            >
              Âà∑Êñ∞
            </Button>
            <Button
              color="primary"
              startContent={<Upload className="h-4 w-4" />}
              onClick={onUploadOpen}
            >
              ÊâπÈáèÂØºÂÖ•
            </Button>
            <Button
              color="primary"
              variant="flat"
              startContent={<Plus className="h-4 w-4" />}
              onClick={handleCreate}
            >
              Êñ∞Â¢ûÂïÜÂìÅ
            </Button>
          </div>
        </div>

        {/* Ê®°ÊùøÈÄâÊã©Âô® */}
        <Card>
          <CardBody className="p-4">
            <div className="flex items-center gap-4">
              <div className="flex items-center gap-2">
                <Package className="h-5 w-5 text-primary" />
                <span className="text-sm font-medium">ÈÄâÊã©ÂïÜÂìÅÊ®°Êùø:</span>
              </div>
              <Select
                placeholder="ËØ∑ÈÄâÊã©Ê®°Êùø"
                size="sm"
                className="max-w-xs"
                selectedKeys={
                  selectedTemplateId ? new Set([selectedTemplateId]) : new Set()
                }
                onSelectionChange={keys => {
                  const selectedKey = Array.from(keys as Set<string>)[0]
                  if (selectedKey) {
                    setSelectedTemplateId(selectedKey)
                    setPage(1) // ÈáçÁΩÆÂà∞Á¨¨‰∏ÄÈ°µ
                    setSelectedKeys(new Set()) // Ê∏ÖÁ©∫ÈÄâÊã©
                  }
                }}
                isLoading={templatesLoading}
                isDisabled={templatesLoading}
              >
                {templates.map(template => (
                  <SelectItem key={template.id} textValue={template.name}>
                    <div className="flex w-full items-center justify-between">
                      <div>
                        <span className="font-medium">{template.name}</span>
                        {template.isDefault && (
                          <Chip
                            size="sm"
                            color="primary"
                            variant="flat"
                            className="ml-2"
                          >
                            ÈªòËÆ§
                          </Chip>
                        )}
                      </div>
                      <div className="text-xs text-default-500">
                        {template.statistics.productCount} ‰∏™ÂïÜÂìÅ
                      </div>
                    </div>
                  </SelectItem>
                ))}
              </Select>
              {selectedTemplateId && (
                <div className="text-sm text-default-500">
                  ÂΩìÂâçÊ®°Êùø:{" "}
                  <span className="font-medium">
                    {templates.find(t => t.id === selectedTemplateId)?.name ||
                      "Êú™Áü•Ê®°Êùø"}
                  </span>
                </div>
              )}
              {!selectedTemplateId && !templatesLoading && (
                <div className="text-sm text-warning">
                  ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™Ê®°ÊùøÊù•ÁÆ°ÁêÜÂïÜÂìÅ
                </div>
              )}
            </div>
          </CardBody>
        </Card>

        {/* ÊêúÁ¥¢ËøáÊª§Âô® */}
        <ProductSearchBar
          onSearch={searchFilters => {
            setFilters(searchFilters)
            setPage(1)
            setSelectedKeys(new Set())
            // ‰ΩøÁî®Êñ∞ÁöÑfiltersÁ´ãÂç≥ÊêúÁ¥¢
            if (selectedTemplateId) {
              fetchProductsWithFilters(searchFilters)
              fetchAllProductIdsWithFilters(searchFilters)
            }
          }}
          onClear={() => {
            setFilters({})
            setPage(1)
            setSelectedKeys(new Set())
            // ‰ΩøÁî®Á©∫filtersÁ´ãÂç≥ÊêúÁ¥¢
            if (selectedTemplateId) {
              fetchProductsWithFilters({})
              fetchAllProductIdsWithFilters({})
            }
          }}
          isLoading={loading}
        />

        {/* ÊâπÈáèÊìç‰ΩúÂ∑•ÂÖ∑Ê†è */}
        {selectedKeys.size > 0 && (
          <Card>
            <CardBody>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <span className="text-sm text-default-600">
                    Â∑≤ÈÄâÊã© {selectedKeys.size} ‰∏™ÂïÜÂìÅ
                  </span>
                  <Button
                    size="sm"
                    variant="light"
                    onClick={() => setSelectedKeys(new Set())}
                    startContent={<X className="h-4 w-4" />}
                  >
                    ÂèñÊ∂àÈÄâÊã©
                  </Button>
                </div>
                <div className="flex items-center gap-2">
                  <Button
                    size="sm"
                    color="success"
                    variant="flat"
                    onClick={() => batchOperation("activate")}
                    isLoading={batchLoading}
                    startContent={<CheckCircle className="h-4 w-4" />}
                  >
                    ÊâπÈáèÂêØÁî®
                  </Button>
                  <Button
                    size="sm"
                    color="warning"
                    variant="flat"
                    onClick={() => batchOperation("deactivate")}
                    isLoading={batchLoading}
                    startContent={<XCircle className="h-4 w-4" />}
                  >
                    ÊâπÈáèÁ¶ÅÁî®
                  </Button>
                  <Button
                    size="sm"
                    color="danger"
                    variant="flat"
                    onClick={handleBatchDelete}
                    isLoading={batchLoading}
                    startContent={<Trash2 className="h-4 w-4" />}
                  >
                    ÊâπÈáèÂà†Èô§
                  </Button>
                </div>
              </div>
            </CardBody>
          </Card>
        )}

        {/* ‰∫ßÂìÅË°®Ê†º */}
        <Card>
          <CardHeader className="flex justify-between">
            <div>
              <h2 className="text-lg font-semibold">‰∫ßÂìÅÂàóË°®</h2>
              <p className="text-sm text-default-500">ÂÖ± {total} ‰∏™ÂïÜÂìÅ</p>
            </div>
            <div className="flex items-center gap-4">
              <span className="text-sm text-default-500">ÊØèÈ°µÊòæÁ§∫</span>
              <Select
                size="sm"
                variant="bordered"
                selectedKeys={new Set([limit.toString()])}
                className="w-32"
                onSelectionChange={keys => {
                  const selectedKey = Array.from(keys as Set<string>)[0]
                  if (selectedKey) {
                    handleLimitChange(Number(selectedKey))
                  }
                }}
              >
                {pageSizeOptions.map(option => (
                  <SelectItem key={option.value.toString()}>
                    {option.label}
                  </SelectItem>
                ))}
              </Select>
            </div>
          </CardHeader>
          <CardBody>
            {loading ? (
              <div className="flex items-center justify-center py-12">
                <RefreshCw className="h-6 w-6 animate-spin" />
                <span className="ml-2">Âä†ËΩΩ‰∏≠...</span>
              </div>
            ) : products.length === 0 ? (
              <EmptyState
                icon={<Package className="h-12 w-12" />}
                title="ÊöÇÊó†ÂïÜÂìÅÊï∞ÊçÆ"
                description="ÂºÄÂßãÊ∑ªÂä†ÊÇ®ÁöÑÁ¨¨‰∏Ä‰∏™ÂïÜÂìÅÔºåÊàñÂØºÂÖ•Áé∞ÊúâÁöÑÂïÜÂìÅÊï∞ÊçÆ"
                action={{
                  label: "ÊâπÈáèÂØºÂÖ•",
                  onClick: onUploadOpen,
                }}
              />
            ) : (
              <>
                <Table aria-label="‰∫ßÂìÅË°®Ê†º">
                  <TableHeader>
                    <TableColumn width={80}>
                      <div className="flex items-center gap-1">
                        <Checkbox
                          isSelected={isPageAllSelected}
                          isIndeterminate={
                            isIndeterminate && !isPageAllSelected
                          }
                          onChange={togglePageSelection}
                        />
                        <Dropdown>
                          <DropdownTrigger>
                            <Button
                              isIconOnly
                              size="sm"
                              variant="light"
                              className="h-6 w-6 min-w-6"
                              isLoading={allIdsLoading}
                            >
                              <MoreVertical className="h-3 w-3" />
                            </Button>
                          </DropdownTrigger>
                          <DropdownMenu
                            aria-label="ÈÄâÊã©ÈÄâÈ°π"
                            onAction={key => {
                              if (key === "select-all") {
                                selectAllPages()
                              } else if (key === "select-page") {
                                togglePageSelection()
                              } else if (key === "clear-all") {
                                setSelectedKeys(new Set())
                              }
                            }}
                          >
                            <DropdownItem key="select-page">
                              {isPageAllSelected ? "ÂèñÊ∂àÂΩìÂâçÈ°µ" : "ÈÄâÊã©ÂΩìÂâçÈ°µ"}
                            </DropdownItem>
                            <DropdownItem key="select-all">
                              {isAllSelected
                                ? "ÂèñÊ∂àÂÖ®ÈÄâ"
                                : `ÂÖ®ÈÄâÊâÄÊúâ (${allProductIds.length})`}
                            </DropdownItem>
                            <DropdownItem
                              key="clear-all"
                              className="text-danger"
                            >
                              Ê∏ÖÁ©∫ÈÄâÊã©
                            </DropdownItem>
                          </DropdownMenu>
                        </Dropdown>
                      </div>
                    </TableColumn>
                    <TableColumn>ÂïÜÂìÅ‰ø°ÊÅØ</TableColumn>
                    <TableColumn>ÂìÅÁâå/‰ºÅ‰∏ö</TableColumn>
                    <TableColumn>ÁºñÁ†Å‰ø°ÊÅØ</TableColumn>
                    <TableColumn>ËßÑÊ†º</TableColumn>
                    <TableColumn>‰ª∑Ê†º‰ø°ÊÅØ</TableColumn>
                    <TableColumn>ÁâπÊÄß</TableColumn>
                    <TableColumn>Áä∂ÊÄÅ</TableColumn>
                    <TableColumn width={120}>Êìç‰Ωú</TableColumn>
                  </TableHeader>
                  <TableBody>
                    {products.map(product => (
                      <TableRow key={product._id}>
                        <TableCell>
                          <Checkbox
                            isSelected={selectedKeys.has(product._id)}
                            onChange={() => toggleSelection(product._id)}
                          />
                        </TableCell>
                        <TableCell>
                          <div>
                            <p className="font-medium">
                              {product.name || "Êú™Áü•ÂïÜÂìÅ"}
                            </p>
                            <div className="mt-1 flex gap-2">
                              {product.productType && (
                                <Chip size="sm" variant="flat" color="primary">
                                  {product.productType}
                                </Chip>
                              )}
                              {product.packageType && (
                                <Chip
                                  size="sm"
                                  variant="flat"
                                  color="secondary"
                                >
                                  {product.packageType}
                                </Chip>
                              )}
                            </div>
                          </div>
                        </TableCell>
                        <TableCell>
                          <div>
                            <p className="font-medium">
                              {product.brand || "Êú™Áü•ÂìÅÁâå"}
                            </p>
                            {product.company && (
                              <p className="text-xs text-default-500">
                                {product.company}
                              </p>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="space-y-1">
                            {product.productCode && (
                              <div>
                                <span className="text-xs text-default-500">
                                  ‰∫ßÂìÅÁ†Å:
                                </span>
                                <code className="ml-1 rounded bg-default-100 px-1 text-xs">
                                  {product.productCode}
                                </code>
                              </div>
                            )}
                            {product.boxCode && (
                              <div>
                                <span className="text-xs text-default-500">
                                  ÁõíÁ†Å:
                                </span>
                                <code className="ml-1 rounded bg-default-100 px-1 text-xs">
                                  {product.boxCode}
                                </code>
                              </div>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="space-y-1 text-xs">
                            {product.specifications?.circumference && (
                              <div>
                                Âë®Èïø: {product.specifications.circumference}mm
                              </div>
                            )}
                            {product.specifications?.length && (
                              <div>ÈïøÂ∫¶: {product.specifications.length}</div>
                            )}
                            {product.specifications?.packageQuantity && (
                              <div>
                                {product.specifications.packageQuantity}ÊîØË£Ö
                              </div>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="space-y-1">
                            {/* ÂÖ¨Âè∏‰ª∑ - ‰∏ªË¶ÅÊòæÁ§∫ */}
                            {product.pricing?.companyPrice && (
                              <div className="text-base font-bold text-primary">
                                ¬•{product.pricing.companyPrice}
                                <span className="ml-1 text-xs text-default-500">
                                  ÂÖ¨Âè∏‰ª∑/{product.pricing.unit || "Êù°"}
                                </span>
                              </div>
                            )}
                            {/* Èõ∂ÂîÆ‰ª∑ - Ê¨°Ë¶ÅÊòæÁ§∫ */}
                            {product.pricing?.retailPrice && (
                              <div className="text-sm text-default-500">
                                Èõ∂ÂîÆ‰ª∑: ¬•{product.pricing.retailPrice}
                              </div>
                            )}
                            {/* ‰ª∑Ê†ºÁ±ªÂûã */}
                            {product.pricing?.priceCategory && (
                              <Chip
                                size="sm"
                                variant="flat"
                                color={
                                  product.pricing.priceCategory === "‰∏ÄÁ±ª"
                                    ? "success"
                                    : product.pricing.priceCategory === "‰∫åÁ±ª"
                                      ? "warning"
                                      : "default"
                                }
                              >
                                {product.pricing.priceCategory}
                              </Chip>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="flex flex-col gap-1">
                            <div className="flex flex-wrap gap-1">
                              {product.features?.hasPop && (
                                <Chip size="sm" variant="flat" color="warning">
                                  ÁàÜÁè†
                                </Chip>
                              )}
                              {product.appearance?.color && (
                                <Chip size="sm" variant="flat" color="default">
                                  {product.appearance.color}
                                </Chip>
                              )}
                            </div>
                            {product.chemicalContent?.tarContent && (
                              <div className="text-xs text-default-500">
                                ÁÑ¶Ê≤π{product.chemicalContent.tarContent}mg
                              </div>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          {renderStatusChip(product.isActive ?? true)}
                        </TableCell>
                        <TableCell>{renderActions(product)}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>

                {/* ÂàÜÈ°µ */}
                <div className="mt-6 flex flex-col items-center gap-4 sm:flex-row sm:justify-between">
                  <div className="text-sm text-default-500">
                    ÊòæÁ§∫Á¨¨ {(page - 1) * limit + 1} -{" "}
                    {Math.min(page * limit, total)} Êù°ÔºåÂÖ± {total} Êù°
                  </div>
                  <Pagination
                    total={Math.ceil(total / limit)}
                    page={page}
                    onChange={setPage}
                    showControls
                    showShadow
                    color="primary"
                  />
                  <div className="text-sm text-default-500">
                    Á¨¨ {page} È°µÔºåÂÖ± {Math.ceil(total / limit)} È°µ
                  </div>
                </div>
              </>
            )}
          </CardBody>
        </Card>

        {/* Êñá‰ª∂‰∏ä‰º†Ê®°ÊÄÅÊ°Ü */}
        <RealProgressUpload
          isOpen={isUploadOpen}
          onClose={onUploadClose}
          endpoint={buildApiUrl("/products/upload")}
          templateId={selectedTemplateId}
          onSuccess={handleUploadSuccess}
          acceptedFileTypes={[".csv", ".xlsx", ".xls"]}
          maxFileSize={10}
        />

        {/* Âà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü */}
        <ConfirmModal
          isOpen={isDeleteOpen}
          onOpenChange={onDeleteClose}
          onConfirm={confirmDelete}
          title="Á°ÆËÆ§Âà†Èô§"
          message="ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÂïÜÂìÅÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ"
          type="danger"
          confirmText="Âà†Èô§"
          cancelText="ÂèñÊ∂à"
        />

        {/* ÊâπÈáèÂà†Èô§Á°ÆËÆ§Ê®°ÊÄÅÊ°Ü */}
        <ConfirmModal
          isOpen={isBatchDeleteOpen}
          onOpenChange={onBatchDeleteClose}
          onConfirm={confirmBatchDelete}
          title="Á°ÆËÆ§ÊâπÈáèÂà†Èô§"
          message={`ÊÇ®Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${selectedKeys.size} ‰∏™ÂïÜÂìÅÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ`}
          type="danger"
          confirmText="Âà†Èô§"
          cancelText="ÂèñÊ∂à"
          isLoading={batchLoading}
        />

        {/* ÁºñËæëÂïÜÂìÅÊ®°ÊÄÅÊ°Ü */}
        <Modal
          isOpen={isEditOpen}
          onClose={onEditClose}
          size="5xl"
          scrollBehavior="inside"
        >
          <ModalContent>
            {onClose => {
              const submitFormRef = useRef<(() => void) | null>(null)

              return (
                <>
                  <ModalHeader>ÁºñËæëÂïÜÂìÅ</ModalHeader>
                  <ModalBody>
                    <ProductForm
                      product={editingProduct}
                      onSubmit={updateProduct}
                      onCancel={onEditClose}
                      isLoading={loading}
                      renderButtons={() => null}
                      exposeSubmit={submitFn => {
                        submitFormRef.current = submitFn
                      }}
                    />
                  </ModalBody>
                  <ModalFooter>
                    <Button variant="light" onPress={onEditClose}>
                      ÂèñÊ∂à
                    </Button>
                    <Button
                      color="primary"
                      onPress={() => {
                        if (submitFormRef.current) {
                          submitFormRef.current()
                        }
                      }}
                      isLoading={loading}
                    >
                      Êõ¥Êñ∞
                    </Button>
                  </ModalFooter>
                </>
              )
            }}
          </ModalContent>
        </Modal>

        {/* Êñ∞Â¢ûÂïÜÂìÅÊ®°ÊÄÅÊ°Ü */}
        <Modal
          isOpen={isCreateOpen}
          onClose={onCreateClose}
          size="5xl"
          scrollBehavior="inside"
        >
          <ModalContent>
            {onClose => {
              const submitFormRef = useRef<(() => void) | null>(null)

              return (
                <>
                  <ModalHeader>Êñ∞Â¢ûÂïÜÂìÅ</ModalHeader>
                  <ModalBody>
                    <ProductForm
                      onSubmit={createProduct}
                      onCancel={onCreateClose}
                      isLoading={loading}
                      renderButtons={() => null}
                      exposeSubmit={submitFn => {
                        submitFormRef.current = submitFn
                      }}
                    />
                  </ModalBody>
                  <ModalFooter>
                    <Button variant="light" onPress={onCreateClose}>
                      ÂèñÊ∂à
                    </Button>
                    <Button
                      color="primary"
                      onPress={() => {
                        if (submitFormRef.current) {
                          submitFormRef.current()
                        }
                      }}
                      isLoading={loading}
                    >
                      ÂàõÂª∫
                    </Button>
                  </ModalFooter>
                </>
              )
            }}
          </ModalContent>
        </Modal>
      </div>
    </TemplateContext.Provider>
  )
}
