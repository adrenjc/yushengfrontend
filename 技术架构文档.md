# ğŸ—ï¸ æ™ºèƒ½å•†å“åŒ¹é…ç³»ç»Ÿ - æŠ€æœ¯æ¶æ„æ–‡æ¡£

## ğŸ“‹ æŠ€æœ¯é€‰å‹

### å‰ç«¯æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Next.js 14.x + React 18.x + TypeScript 5.x
- **UI ç»„ä»¶åº“**: NextUI 2.x (åŸºäº React Aria + Tailwind CSS)
- **çŠ¶æ€ç®¡ç†**: Zustand + SWR/TanStack Query
- **è·¯ç”±**: Next.js App Router
- **å›¾è¡¨**: Recharts + D3.js
- **æ–‡ä»¶ä¸Šä¼ **: react-dropzone + @next/upload
- **è¡¨æ ¼**: @tanstack/react-table
- **æ ·å¼**: Tailwind CSS + CSS-in-JS (styled-jsx)
- **æ„å»ºå·¥å…·**: Next.js (Turbopack)
- **åŒ…ç®¡ç†**: pnpm

### åç«¯æŠ€æœ¯æ ˆ

- **è¿è¡Œæ—¶**: Node.js 18.x LTS
- **æ¡†æ¶**: Express.js 4.x + TypeScript
- **æ•°æ®åº“**: MongoDB 7.x + Mongoose ODM
- **ç¼“å­˜**: Redis 7.x
- **æ–‡ä»¶å¤„ç†**: multer + xlsx + csv-parser
- **è®¤è¯**: JWT + bcrypt
- **æ—¥å¿—**: winston + morgan
- **API æ–‡æ¡£**: Swagger/OpenAPI 3.x
- **è¿›ç¨‹ç®¡ç†**: PM2
- **ä»»åŠ¡é˜Ÿåˆ—**: Bull Queue

### å¼€å‘è¿ç»´

- **è¿›ç¨‹ç®¡ç†**: PM2 + Nginx
- **ä»£ç è´¨é‡**: ESLint + Prettier + Husky
- **æµ‹è¯•**: Jest + React Testing Library
- **CI/CD**: è‡ªåŠ¨åŒ–è„šæœ¬ + Git Hooks
- **ç›‘æ§**: PM2 ç›‘æ§ + è‡ªå®šä¹‰ç›‘æ§
- **æ—¥å¿—ç®¡ç†**: Winston + æ—¥å¿—è½®è½¬

---

## ğŸ›ï¸ ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CDN/é™æ€èµ„æº                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  è´Ÿè½½å‡è¡¡å™¨                          â”‚
â”‚                 (Nginx/ALB)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚  WebæœåŠ¡1   â”‚ â”‚  WebæœåŠ¡2  â”‚ â”‚  WebæœåŠ¡3  â”‚
â”‚  (Node.js)  â”‚ â”‚ (Node.js) â”‚ â”‚ (Node.js) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚             â”‚             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Redisç¼“å­˜   â”‚ â”‚ MongoDB   â”‚ â”‚æ–‡ä»¶å­˜å‚¨   â”‚
â”‚é›†ç¾¤        â”‚ â”‚å‰¯æœ¬é›†     â”‚ â”‚(Minio)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ é¡¹ç›®ç»“æ„

### å‰ç«¯é¡¹ç›®ç»“æ„

```
smart-match-web/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ favicon.ico
â”‚   â””â”€â”€ images/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ app/                 # Next.js App Router
â”‚   â”‚   â”œâ”€â”€ (dashboard)/     # è·¯ç”±ç»„
â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â”œâ”€â”€ products/
â”‚   â”‚   â”‚   â”œâ”€â”€ matching/
â”‚   â”‚   â”‚   â”œâ”€â”€ review/
â”‚   â”‚   â”‚   â”œâ”€â”€ prices/
â”‚   â”‚   â”‚   â””â”€â”€ reports/
â”‚   â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ api/             # APIè·¯ç”±
â”‚   â”‚   â”œâ”€â”€ globals.css
â”‚   â”‚   â”œâ”€â”€ layout.tsx
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ components/          # é€šç”¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ui/              # åŸºç¡€UIç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ Upload/
â”‚   â”‚   â”œâ”€â”€ DataTable/
â”‚   â”‚   â”œâ”€â”€ MatchingCard/
â”‚   â”‚   â””â”€â”€ Charts/
â”‚   â”œâ”€â”€ lib/                 # å·¥å…·åº“
â”‚   â”‚   â”œâ”€â”€ utils.ts
â”‚   â”‚   â”œâ”€â”€ api.ts
â”‚   â”‚   â””â”€â”€ auth.ts
â”‚   â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰Hooks
â”‚   â”œâ”€â”€ stores/              # çŠ¶æ€ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ auth.ts
â”‚   â”‚   â”œâ”€â”€ matching.ts
â”‚   â”‚   â””â”€â”€ products.ts
â”‚   â”œâ”€â”€ types/               # TypeScriptç±»å‹å®šä¹‰
â”‚   â””â”€â”€ constants/           # å¸¸é‡å®šä¹‰
â”œâ”€â”€ package.json
â”œâ”€â”€ next.config.js
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ tailwind.config.ts
â””â”€â”€ components.json          # NextUIé…ç½®
```

### åç«¯é¡¹ç›®ç»“æ„

```
smart-match-api/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/         # æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ auth.controller.ts
â”‚   â”‚   â”œâ”€â”€ product.controller.ts
â”‚   â”‚   â”œâ”€â”€ matching.controller.ts
â”‚   â”‚   â””â”€â”€ price.controller.ts
â”‚   â”œâ”€â”€ services/            # ä¸šåŠ¡é€»è¾‘æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ matching.service.ts
â”‚   â”‚   â”œâ”€â”€ excel.service.ts
â”‚   â”‚   â””â”€â”€ notification.service.ts
â”‚   â”œâ”€â”€ models/              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Product.ts
â”‚   â”‚   â”œâ”€â”€ MatchingTask.ts
â”‚   â”‚   â””â”€â”€ User.ts
â”‚   â”œâ”€â”€ middleware/          # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts
â”‚   â”‚   â”œâ”€â”€ validation.middleware.ts
â”‚   â”‚   â””â”€â”€ error.middleware.ts
â”‚   â”œâ”€â”€ routes/              # è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”‚   â”œâ”€â”€ matching-algorithm.ts
â”‚   â”‚   â”œâ”€â”€ excel-parser.ts
â”‚   â”‚   â””â”€â”€ logger.ts
â”‚   â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ database.ts
â”‚   â”‚   â”œâ”€â”€ redis.ts
â”‚   â”‚   â””â”€â”€ env.ts
â”‚   â””â”€â”€ app.ts
â”œâ”€â”€ tests/                   # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ docs/                    # APIæ–‡æ¡£
â”œâ”€â”€ docker/                  # Dockeré…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ ecosystem.config.js      # PM2é…ç½®
```

---

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. æ™ºèƒ½åŒ¹é…å¼•æ“

#### åŒ¹é…ç®—æ³•æ¥å£

```typescript
interface MatchingEngine {
  /**
   * æ‰§è¡Œæ™ºèƒ½åŒ¹é…
   * @param wholesaleItems æ‰¹å‘å•†å“æ•°æ®
   * @param productArchive å•†å“æ¡£æ¡ˆ
   * @param config åŒ¹é…é…ç½®
   */
  match(
    wholesaleItems: WholesaleItem[],
    productArchive: ProductArchive[],
    config: MatchingConfig
  ): Promise<MatchingResult[]>

  /**
   * è®¡ç®—ç›¸ä¼¼åº¦åˆ†æ•°
   */
  calculateSimilarity(
    wholesale: WholesaleItem,
    product: ProductArchive
  ): SimilarityScore

  /**
   * å­¦ä¹ ç”¨æˆ·é€‰æ‹©åå¥½
   */
  learnFromUserChoice(
    wholesale: WholesaleItem,
    selectedProduct: ProductArchive,
    rejectedProducts: ProductArchive[]
  ): void
}
```

#### ç®—æ³•å®ç°

```typescript
class SmartMatchingEngine implements MatchingEngine {
  private readonly weights = {
    name: 0.35,
    brand: 0.25,
    keywords: 0.2,
    package: 0.1,
    price: 0.1,
  }

  async match(
    wholesaleItems: WholesaleItem[],
    productArchive: ProductArchive[],
    config: MatchingConfig
  ): Promise<MatchingResult[]> {
    const results: MatchingResult[] = []

    for (const item of wholesaleItems) {
      const candidates = await this.findCandidates(item, productArchive)
      const scoredCandidates = candidates
        .map((candidate) => ({
          product: candidate,
          score: this.calculateSimilarity(item, candidate),
        }))
        .sort((a, b) => b.score.total - a.score.total)
        .slice(0, 5) // å–å‰5ä¸ªå€™é€‰

      results.push({
        wholesaleItem: item,
        candidates: scoredCandidates,
        confidence: this.determineConfidence(
          scoredCandidates[0]?.score.total || 0
        ),
        recommendedAction: this.getRecommendedAction(
          scoredCandidates[0]?.score.total || 0
        ),
      })
    }

    return results
  }

  calculateSimilarity(
    wholesale: WholesaleItem,
    product: ProductArchive
  ): SimilarityScore {
    const nameScore = this.calculateNameSimilarity(wholesale.name, product.name)
    const brandScore = this.calculateBrandSimilarity(
      wholesale.name,
      product.brand
    )
    const keywordScore = this.calculateKeywordSimilarity(
      wholesale.name,
      product.keywords
    )
    const packageScore = this.calculatePackageSimilarity(
      wholesale.name,
      product.specifications
    )
    const priceScore = this.calculatePriceSimilarity(
      wholesale.price,
      product.specifications.price
    )

    const total =
      nameScore * this.weights.name +
      brandScore * this.weights.brand +
      keywordScore * this.weights.keywords +
      packageScore * this.weights.package +
      priceScore * this.weights.price

    return {
      name: nameScore,
      brand: brandScore,
      keywords: keywordScore,
      package: packageScore,
      price: priceScore,
      total: Math.round(total * 100) / 100,
    }
  }
}
```

### 2. ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿ

#### é˜Ÿåˆ—é…ç½®

```typescript
import Bull from "bull"
import { redisConfig } from "../config/redis"

// åŒ¹é…ä»»åŠ¡é˜Ÿåˆ—
export const matchingQueue = new Bull("matching tasks", {
  redis: redisConfig,
  defaultJobOptions: {
    removeOnComplete: 100,
    removeOnFail: 50,
    attempts: 3,
    backoff: {
      type: "exponential",
      delay: 2000,
    },
  },
})

// ä»·æ ¼æ›´æ–°é˜Ÿåˆ—
export const priceUpdateQueue = new Bull("price updates", {
  redis: redisConfig,
})

// æŠ¥è¡¨ç”Ÿæˆé˜Ÿåˆ—
export const reportQueue = new Bull("report generation", {
  redis: redisConfig,
})
```

#### ä»»åŠ¡å¤„ç†å™¨

```typescript
matchingQueue.process("smart-matching", async (job) => {
  const { taskId, wholesaleData, config } = job.data

  try {
    // æ›´æ–°ä»»åŠ¡çŠ¶æ€
    await MatchingTask.findByIdAndUpdate(taskId, {
      status: "processing",
      startedAt: new Date(),
    })

    const engine = new SmartMatchingEngine()
    const productArchive = await Product.find({})

    // æ‰§è¡ŒåŒ¹é…
    const results = await engine.match(wholesaleData, productArchive, config)

    // ä¿å­˜ç»“æœ
    await MatchingRecord.insertMany(
      results.map((result) => ({
        taskId,
        ...result,
      }))
    )

    // æ›´æ–°ä»»åŠ¡å®ŒæˆçŠ¶æ€
    await MatchingTask.findByIdAndUpdate(taskId, {
      status: "completed",
      completedAt: new Date(),
      totalItems: results.length,
      processedItems: results.length,
    })

    return { success: true, processedCount: results.length }
  } catch (error) {
    await MatchingTask.findByIdAndUpdate(taskId, {
      status: "failed",
      error: error.message,
    })
    throw error
  }
})
```

### 3. æ•°æ®æ¨¡å‹å®šä¹‰

#### MongoDB Schema

```typescript
// å•†å“æ¡£æ¡ˆæ¨¡å‹
const ProductSchema = new Schema(
  {
    name: { type: String, required: true, index: true },
    brand: { type: String, required: true, index: true },
    keywords: [{ type: String, index: true }],
    category: { type: String, index: true },
    specifications: {
      packageType: String,
      size: String,
      price: Number,
    },
    wholesaleName: String,
    wholesalePrice: Number,
    isActive: { type: Boolean, default: true },
    createdAt: { type: Date, default: Date.now },
    updatedAt: { type: Date, default: Date.now },
  },
  {
    timestamps: true,
  }
)

// æ·»åŠ æ–‡æœ¬æœç´¢ç´¢å¼•
ProductSchema.index({
  name: "text",
  brand: "text",
  keywords: "text",
})

// åŒ¹é…ä»»åŠ¡æ¨¡å‹
const MatchingTaskSchema = new Schema(
  {
    filename: { type: String, required: true },
    originalFilename: String,
    fileSize: Number,
    status: {
      type: String,
      enum: ["pending", "processing", "review", "completed", "failed"],
      default: "pending",
    },
    config: {
      threshold: { type: Number, default: 65 },
      autoConfirmThreshold: { type: Number, default: 90 },
      strategies: {
        brandPriority: { type: Boolean, default: true },
        keywordMatching: { type: Boolean, default: true },
        packageTypeRecognition: { type: Boolean, default: true },
        priceValidation: { type: Boolean, default: true },
      },
    },
    progress: {
      totalItems: { type: Number, default: 0 },
      processedItems: { type: Number, default: 0 },
      confirmedItems: { type: Number, default: 0 },
      pendingItems: { type: Number, default: 0 },
    },
    createdBy: { type: Schema.Types.ObjectId, ref: "User", required: true },
    startedAt: Date,
    completedAt: Date,
    error: String,
  },
  {
    timestamps: true,
  }
)

// åŒ¹é…è®°å½•æ¨¡å‹
const MatchingRecordSchema = new Schema(
  {
    taskId: {
      type: Schema.Types.ObjectId,
      ref: "MatchingTask",
      required: true,
    },
    wholesaleName: { type: String, required: true },
    wholesalePrice: { type: Number, required: true },

    candidates: [
      {
        productId: { type: Schema.Types.ObjectId, ref: "Product" },
        score: {
          name: Number,
          brand: Number,
          keywords: Number,
          package: Number,
          price: Number,
          total: Number,
        },
        confidence: {
          type: String,
          enum: ["high", "medium", "low"],
        },
        reason: String,
      },
    ],

    selectedMatch: {
      productId: { type: Schema.Types.ObjectId, ref: "Product" },
      confirmedBy: { type: Schema.Types.ObjectId, ref: "User" },
      confirmedAt: Date,
      note: String,
      confidence: Number,
    },

    status: {
      type: String,
      enum: ["pending", "reviewing", "confirmed", "rejected", "exception"],
      default: "pending",
    },

    priority: {
      type: String,
      enum: ["high", "medium", "low"],
      default: "medium",
    },

    reviewHistory: [
      {
        action: String,
        performer: { type: Schema.Types.ObjectId, ref: "User" },
        timestamp: { type: Date, default: Date.now },
        note: String,
        previousStatus: String,
        newStatus: String,
      },
    ],
  },
  {
    timestamps: true,
  }
)
```

### 4. API æ¥å£è®¾è®¡

#### RESTful API ç»“æ„

```typescript
// åŒ¹é…ä»»åŠ¡ç›¸å…³æ¥å£
POST   /api/matching/tasks              // åˆ›å»ºåŒ¹é…ä»»åŠ¡
GET    /api/matching/tasks              // è·å–ä»»åŠ¡åˆ—è¡¨
GET    /api/matching/tasks/:id          // è·å–ä»»åŠ¡è¯¦æƒ…
PUT    /api/matching/tasks/:id          // æ›´æ–°ä»»åŠ¡çŠ¶æ€
DELETE /api/matching/tasks/:id          // åˆ é™¤ä»»åŠ¡

// åŒ¹é…è®°å½•ç›¸å…³æ¥å£
GET    /api/matching/records            // è·å–åŒ¹é…è®°å½•åˆ—è¡¨
GET    /api/matching/records/:id        // è·å–è®°å½•è¯¦æƒ…
PUT    /api/matching/records/:id/confirm // ç¡®è®¤åŒ¹é…
PUT    /api/matching/records/:id/reject  // æ‹’ç»åŒ¹é…
POST   /api/matching/records/batch      // æ‰¹é‡æ“ä½œ

// å•†å“æ¡£æ¡ˆç›¸å…³æ¥å£
GET    /api/products                    // è·å–å•†å“åˆ—è¡¨
POST   /api/products                    // åˆ›å»ºå•†å“
PUT    /api/products/:id                // æ›´æ–°å•†å“
DELETE /api/products/:id                // åˆ é™¤å•†å“
POST   /api/products/import             // æ‰¹é‡å¯¼å…¥
GET    /api/products/export             // å¯¼å‡ºå•†å“

// ä»·æ ¼ç®¡ç†ç›¸å…³æ¥å£
GET    /api/prices/changes              // è·å–ä»·æ ¼å˜åŠ¨è®°å½•
POST   /api/prices/update               // æ›´æ–°ä»·æ ¼
GET    /api/prices/analysis             // ä»·æ ¼åˆ†ææ•°æ®
GET    /api/prices/trends               // ä»·æ ¼è¶‹åŠ¿æ•°æ®

// ç»Ÿè®¡æŠ¥è¡¨ç›¸å…³æ¥å£
GET    /api/reports/efficiency          // æ•ˆç‡æŠ¥è¡¨
GET    /api/reports/accuracy            // å‡†ç¡®ç‡æŠ¥è¡¨
GET    /api/reports/summary             // æ±‡æ€»æŠ¥è¡¨
```

#### æ¥å£å®ç°ç¤ºä¾‹

```typescript
// åŒ¹é…ä»»åŠ¡æ§åˆ¶å™¨
export class MatchingController {
  async createTask(req: Request, res: Response) {
    try {
      const { file } = req
      const userId = req.user.id

      // è§£æExcelæ–‡ä»¶
      const wholesaleData = await ExcelService.parseWholesaleFile(file.buffer)

      // åˆ›å»ºä»»åŠ¡è®°å½•
      const task = new MatchingTask({
        filename: file.filename,
        originalFilename: file.originalname,
        fileSize: file.size,
        createdBy: userId,
        progress: {
          totalItems: wholesaleData.length,
        },
      })

      await task.save()

      // æ·»åŠ åˆ°é˜Ÿåˆ—
      await matchingQueue.add("smart-matching", {
        taskId: task._id,
        wholesaleData,
        config: req.body.config || {},
      })

      res.status(201).json({
        success: true,
        data: task,
        message: "åŒ¹é…ä»»åŠ¡åˆ›å»ºæˆåŠŸ",
      })
    } catch (error) {
      res.status(500).json({
        success: false,
        message: error.message,
      })
    }
  }

  async getTaskProgress(req: Request, res: Response) {
    try {
      const { id } = req.params
      const task = await MatchingTask.findById(id).populate(
        "createdBy",
        "name email"
      )

      if (!task) {
        return res.status(404).json({
          success: false,
          message: "ä»»åŠ¡ä¸å­˜åœ¨",
        })
      }

      // è·å–åŒ¹é…è®°å½•ç»Ÿè®¡
      const recordStats = await MatchingRecord.aggregate([
        { $match: { taskId: new ObjectId(id) } },
        {
          $group: {
            _id: "$status",
            count: { $sum: 1 },
          },
        },
      ])

      res.json({
        success: true,
        data: {
          task,
          statistics: recordStats,
        },
      })
    } catch (error) {
      res.status(500).json({
        success: false,
        message: error.message,
      })
    }
  }
}
```

---

## ğŸ”’ å®‰å…¨æ¶æ„

### 1. è®¤è¯æˆæƒ

```typescript
// JWTä»¤ç‰Œé…ç½®
const jwtConfig = {
  secret: process.env.JWT_SECRET,
  expiresIn: "24h",
  refreshExpiresIn: "7d",
}

// æƒé™ä¸­é—´ä»¶
export const authorize = (permissions: string[]) => {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const user = req.user
      const hasPermission = permissions.some((permission) =>
        user.permissions.includes(permission)
      )

      if (!hasPermission) {
        return res.status(403).json({
          success: false,
          message: "æƒé™ä¸è¶³",
        })
      }

      next()
    } catch (error) {
      res.status(401).json({
        success: false,
        message: "è®¤è¯å¤±è´¥",
      })
    }
  }
}
```

### 2. æ•°æ®åŠ å¯†

- å¯†ç ä½¿ç”¨ bcrypt å“ˆå¸ŒåŠ å¯†
- æ•æ„Ÿæ•°æ®ä¼ è¾“ä½¿ç”¨ HTTPS
- æ•°æ®åº“è¿æ¥ä½¿ç”¨ TLS åŠ å¯†
- API å¯†é’¥åŠ å¯†å­˜å‚¨

### 3. è¾“å…¥éªŒè¯

```typescript
// è¯·æ±‚æ•°æ®éªŒè¯ä¸­é—´ä»¶
export const validateRequest = (schema: Joi.Schema) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const { error } = schema.validate(req.body)

    if (error) {
      return res.status(400).json({
        success: false,
        message: "è¯·æ±‚æ•°æ®æ ¼å¼é”™è¯¯",
        details: error.details,
      })
    }

    next()
  }
}

// æ–‡ä»¶ä¸Šä¼ éªŒè¯
export const validateFileUpload = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  const { file } = req

  if (!file) {
    return res.status(400).json({
      success: false,
      message: "è¯·ä¸Šä¼ æ–‡ä»¶",
    })
  }

  // æ£€æŸ¥æ–‡ä»¶ç±»å‹
  const allowedTypes = [
    "application/vnd.ms-excel",
    "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
  ]

  if (!allowedTypes.includes(file.mimetype)) {
    return res.status(400).json({
      success: false,
      message: "æ–‡ä»¶ç±»å‹ä¸æ”¯æŒï¼Œè¯·ä¸Šä¼ Excelæ–‡ä»¶",
    })
  }

  // æ£€æŸ¥æ–‡ä»¶å¤§å° (10MB)
  if (file.size > 10 * 1024 * 1024) {
    return res.status(400).json({
      success: false,
      message: "æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB",
    })
  }

  next()
}
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. æ•°æ®åº“ä¼˜åŒ–

```typescript
// æ•°æ®åº“è¿æ¥æ± é…ç½®
const mongoConfig = {
  maxPoolSize: 10,
  minPoolSize: 2,
  maxIdleTimeMS: 30000,
  serverSelectionTimeoutMS: 5000,
  socketTimeoutMS: 45000,
}

// æŸ¥è¯¢ä¼˜åŒ–
class ProductService {
  // ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
  async searchProducts(query: string, filters: any) {
    const aggregation = [
      {
        $match: {
          $and: [
            { $text: { $search: query } },
            filters.brand ? { brand: filters.brand } : {},
            filters.category ? { category: filters.category } : {},
          ],
        },
      },
      {
        $addFields: {
          score: { $meta: "textScore" },
        },
      },
      {
        $sort: { score: { $meta: "textScore" } },
      },
      {
        $limit: 50,
      },
    ]

    return Product.aggregate(aggregation)
  }

  // åˆ†é¡µæŸ¥è¯¢
  async getProductsPaginated(page: number, limit: number) {
    const skip = (page - 1) * limit

    const [products, total] = await Promise.all([
      Product.find({}).skip(skip).limit(limit).lean(), // ä½¿ç”¨lean()æé«˜æ€§èƒ½
      Product.countDocuments({}),
    ])

    return {
      products,
      pagination: {
        page,
        limit,
        total,
        pages: Math.ceil(total / limit),
      },
    }
  }
}
```

### 2. ç¼“å­˜ç­–ç•¥

```typescript
// Redisç¼“å­˜é…ç½®
class CacheService {
  private redis: Redis

  constructor() {
    this.redis = new Redis({
      host: process.env.REDIS_HOST,
      port: parseInt(process.env.REDIS_PORT),
      password: process.env.REDIS_PASSWORD,
      retryDelayOnFailover: 100,
      enableReadyCheck: false,
      maxRetriesPerRequest: null,
    })
  }

  // ç¼“å­˜å•†å“æ•°æ®
  async cacheProducts(products: Product[]) {
    const pipeline = this.redis.pipeline()

    products.forEach((product) => {
      pipeline.setex(
        `product:${product._id}`,
        3600, // 1å°æ—¶è¿‡æœŸ
        JSON.stringify(product)
      )
    })

    await pipeline.exec()
  }

  // ç¼“å­˜åŒ¹é…ç»“æœ
  async cacheMatchingResults(taskId: string, results: any[]) {
    await this.redis.setex(
      `matching:${taskId}`,
      1800, // 30åˆ†é’Ÿè¿‡æœŸ
      JSON.stringify(results)
    )
  }

  // ç¼“å­˜ç»Ÿè®¡æ•°æ®
  async cacheStatistics(key: string, data: any, ttl: number = 300) {
    await this.redis.setex(`stats:${key}`, ttl, JSON.stringify(data))
  }
}
```

### 3. å‰ç«¯æ€§èƒ½ä¼˜åŒ–

```typescript
// Next.js åº”ç”¨ç»„ä»¶é…ç½®
import { NextUIProvider } from "@nextui-org/react"
import { ThemeProvider as NextThemesProvider } from "next-themes"

// è™šæ‹Ÿæ»šåŠ¨ç»„ä»¶ (åŸºäº NextUI Table)
import {
  Table,
  TableHeader,
  TableColumn,
  TableBody,
  TableRow,
  TableCell,
} from "@nextui-org/react"
import { useMemo } from "react"

const VirtualizedTable: React.FC<{
  items: any[]
  columns: any[]
  height?: number
}> = ({ items, columns, height = 400 }) => {
  const rows = useMemo(() => {
    return items.map((item, index) => ({
      key: index,
      ...item,
    }))
  }, [items])

  return (
    <Table
      aria-label='æ•°æ®è¡¨æ ¼'
      selectionMode='multiple'
      isStriped
      classNames={{
        wrapper: `max-h-[${height}px]`,
      }}
    >
      <TableHeader columns={columns}>
        {(column) => (
          <TableColumn
            key={column.key}
            align={column.align}
            allowsSorting={column.sortable}
          >
            {column.label}
          </TableColumn>
        )}
      </TableHeader>
      <TableBody items={rows}>
        {(item) => (
          <TableRow key={item.key}>
            {(columnKey) => <TableCell>{item[columnKey]}</TableCell>}
          </TableRow>
        )}
      </TableBody>
    </Table>
  )
}

// æ— é™æ»šåŠ¨ Hook (ç»“åˆ SWR)
import useSWRInfinite from "swr/infinite"

const useInfiniteData = <T>(endpoint: string, pageSize: number = 20) => {
  const { data, error, size, setSize, isValidating, isLoading } =
    useSWRInfinite<{ data: T[]; hasMore: boolean }>(
      (index) => `${endpoint}?page=${index + 1}&limit=${pageSize}`,
      fetcher
    )

  const items = data ? data.flatMap((page) => page.data) : []
  const hasMore = data && data[data.length - 1]?.hasMore

  return {
    items,
    error,
    isLoading,
    isValidating,
    loadMore: () => setSize(size + 1),
    hasMore,
  }
}

// çŠ¶æ€ç®¡ç† (Zustand)
import { create } from "zustand"
import { devtools, persist } from "zustand/middleware"

interface AppState {
  theme: "light" | "dark"
  user: User | null
  setTheme: (theme: "light" | "dark") => void
  setUser: (user: User | null) => void
}

export const useAppStore = create<AppState>()(
  devtools(
    persist(
      (set) => ({
        theme: "light",
        user: null,
        setTheme: (theme) => set({ theme }),
        setUser: (user) => set({ user }),
      }),
      {
        name: "app-storage",
        partialize: (state) => ({ theme: state.theme }),
      }
    )
  )
)
```

---

## ğŸš€ éƒ¨ç½²æ¶æ„

### æœåŠ¡å™¨éƒ¨ç½²é…ç½®

#### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: CentOS 7+ / Ubuntu 18.04+ / Windows Server 2019+
- **Node.js**: 18.x LTS
- **å†…å­˜**: æœ€ä½ 4GBï¼Œæ¨è 8GB+
- **å­˜å‚¨**: æœ€ä½ 50GBï¼Œæ¨è 100GB+
- **ç½‘ç»œ**: ç¨³å®šçš„ç½‘ç»œè¿æ¥

#### ç¯å¢ƒå‡†å¤‡

```bash
# 1. å®‰è£… Node.js 18 (ä½¿ç”¨å›½å†…é•œåƒ)
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# æˆ–è€…ä½¿ç”¨ nvm (æ¨è)
curl -o- https://gitee.com/mirrors/nvm/raw/master/install.sh | bash
nvm install 18
nvm use 18

# 2. é…ç½® npm å›½å†…é•œåƒ
npm config set registry https://registry.npmmirror.com

# 3. å®‰è£… pnpm (å¯é€‰)
npm install -g pnpm
pnpm config set registry https://registry.npmmirror.com

# 4. å®‰è£… PM2
npm install -g pm2

# 5. å®‰è£… MongoDB (ä½¿ç”¨å®˜æ–¹æºæˆ–é˜¿é‡Œäº‘é•œåƒ)
# CentOS/RHEL
sudo yum install -y mongodb-org

# Ubuntu
sudo apt-get install -y mongodb

# 6. å®‰è£… Redis
sudo yum install -y redis
# æˆ–
sudo apt-get install -y redis-server

# 7. å®‰è£… Nginx
sudo yum install -y nginx
# æˆ–
sudo apt-get install -y nginx
```

### PM2 éƒ¨ç½²é…ç½®

```javascript
// ecosystem.config.js - åç«¯é…ç½®
module.exports = {
  apps: [
    {
      name: "smart-match-api",
      script: "dist/app.js",
      cwd: "/path/to/smart-match-api",
      instances: "max", // æˆ–æŒ‡å®šå®ä¾‹æ•°
      exec_mode: "cluster",
      env: {
        NODE_ENV: "development",
        PORT: 3001,
      },
      env_production: {
        NODE_ENV: "production",
        PORT: 3001,
        MONGODB_URI: "mongodb://localhost:27017/smartmatch",
        REDIS_URL: "redis://localhost:6379",
        JWT_SECRET: "your-jwt-secret",
      },
      error_file: "./logs/err.log",
      out_file: "./logs/out.log",
      log_file: "./logs/combined.log",
      time: true,
      autorestart: true,
      watch: false,
      max_memory_restart: "1G",
      env_file: ".env",
    },
  ],
}

// ecosystem.config.js - å‰ç«¯é…ç½®
module.exports = {
  apps: [
    {
      name: "smart-match-web",
      script: "server.js", // Next.js standalone æ¨¡å¼
      cwd: "/path/to/smart-match-web",
      instances: 2,
      exec_mode: "cluster",
      env: {
        NODE_ENV: "development",
        PORT: 3000,
      },
      env_production: {
        NODE_ENV: "production",
        PORT: 3000,
        NEXT_PUBLIC_API_URL: "http://localhost:3001",
      },
      error_file: "./logs/err.log",
      out_file: "./logs/out.log",
      log_file: "./logs/combined.log",
      time: true,
      autorestart: true,
      watch: false,
      max_memory_restart: "512M",
    },
  ],
}
```

### Nginx é…ç½®

```nginx
# nginx.conf
upstream smart_match_web {
    server 127.0.0.1:3000;
}

upstream smart_match_api {
    server 127.0.0.1:3001;
}

server {
    listen 80;
    server_name your-domain.com;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        proxy_pass http://smart_match_web;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # API ä»£ç†
    location /api/ {
        proxy_pass http://smart_match_api;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶
        client_max_body_size 10M;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        proxy_pass http://smart_match_web;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}

# HTTPS é…ç½® (å¯é€‰)
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /path/to/your/cert.pem;
    ssl_certificate_key /path/to/your/key.pem;

    # SSL é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    # å…¶ä»–é…ç½®åŒä¸Š...
}
```

### éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# deploy.sh - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬

set -e

echo "ğŸš€ å¼€å§‹éƒ¨ç½²æ™ºèƒ½å•†å“åŒ¹é…ç³»ç»Ÿ..."

# é…ç½®å˜é‡
PROJECT_DIR="/opt/smart-match-system"
API_DIR="$PROJECT_DIR/api"
WEB_DIR="$PROJECT_DIR/web"
BACKUP_DIR="/opt/backups/$(date +%Y%m%d_%H%M%S)"

# åˆ›å»ºå¤‡ä»½
echo "ğŸ“¦ åˆ›å»ºå¤‡ä»½..."
mkdir -p $BACKUP_DIR
if [ -d "$PROJECT_DIR" ]; then
    cp -r $PROJECT_DIR $BACKUP_DIR/
fi

# æ‹‰å–æœ€æ–°ä»£ç 
echo "ğŸ“¥ æ‹‰å–æœ€æ–°ä»£ç ..."
cd $PROJECT_DIR
git pull origin main

# éƒ¨ç½²åç«¯
echo "ğŸ”§ éƒ¨ç½²åç«¯..."
cd $API_DIR
npm install --production
npm run build

# é‡å¯åç«¯æœåŠ¡
pm2 restart smart-match-api || pm2 start ecosystem.config.js --env production

# éƒ¨ç½²å‰ç«¯
echo "ğŸ¨ éƒ¨ç½²å‰ç«¯..."
cd $WEB_DIR
npm install
npm run build

# é‡å¯å‰ç«¯æœåŠ¡
pm2 restart smart-match-web || pm2 start ecosystem.config.js --env production

# é‡æ–°åŠ è½½ Nginx
echo "ğŸ”„ é‡æ–°åŠ è½½ Nginx..."
sudo nginx -t && sudo nginx -s reload

echo "âœ… éƒ¨ç½²å®Œæˆï¼"
echo "ğŸ“Š æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
pm2 status

# å¥åº·æ£€æŸ¥
echo "ğŸ” å¥åº·æ£€æŸ¥..."
sleep 5
curl -f http://localhost:3001/health || echo "âŒ åç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
curl -f http://localhost:3000 || echo "âŒ å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"

echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
```

### è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®

```yaml
# .github/workflows/deploy.yml (å¦‚æœä½¿ç”¨ GitHub Actions)
name: Deploy to Production

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/smart-match-system
            chmod +x deploy.sh
            ./deploy.sh
```

---

## ğŸ“ˆ ç›‘æ§ä¸æ—¥å¿—

### PM2 ç›‘æ§

```javascript
// PM2 ç›‘æ§é…ç½®
// åœ¨ ecosystem.config.js ä¸­æ·»åŠ ç›‘æ§é…ç½®
module.exports = {
  apps: [
    {
      name: "smart-match-api",
      // ... å…¶ä»–é…ç½®
      monitoring: true,
      pmx: true,
    },
  ],

  // éƒ¨ç½²é…ç½®
  deploy: {
    production: {
      user: "deploy",
      host: ["your-server.com"],
      ref: "origin/main",
      repo: "git@github.com:username/smart-match-system.git",
      path: "/opt/smart-match-system",
      "post-deploy": "npm install && npm run build && pm2 reload ecosystem.config.js --env production",
    },
  },
}

// ç›‘æ§å‘½ä»¤
pm2 monit              // å®æ—¶ç›‘æ§
pm2 status             // æŸ¥çœ‹çŠ¶æ€
pm2 logs               // æŸ¥çœ‹æ—¥å¿—
pm2 logs --lines 200   // æŸ¥çœ‹æœ€è¿‘200è¡Œæ—¥å¿—
```

### è‡ªå®šä¹‰ç›‘æ§

```typescript
// è‡ªå®šä¹‰ç›‘æ§ä¸­é—´ä»¶
import { Request, Response, NextFunction } from "express"
import { logger } from "../utils/logger"

interface MetricsData {
  requests: number
  errors: number
  responseTime: number[]
  activeConnections: number
}

class SimpleMonitor {
  private metrics: MetricsData = {
    requests: 0,
    errors: 0,
    responseTime: [],
    activeConnections: 0,
  }

  // ç›‘æ§ä¸­é—´ä»¶
  middleware() {
    return (req: Request, res: Response, next: NextFunction) => {
      const start = Date.now()
      this.metrics.requests++
      this.metrics.activeConnections++

      res.on("finish", () => {
        const duration = Date.now() - start
        this.metrics.responseTime.push(duration)
        this.metrics.activeConnections--

        if (res.statusCode >= 400) {
          this.metrics.errors++
        }

        // è®°å½•æ…¢è¯·æ±‚
        if (duration > 1000) {
          logger.warn(`Slow request: ${req.method} ${req.path} - ${duration}ms`)
        }
      })

      next()
    }
  }

  // è·å–ç›‘æ§æ•°æ®
  getMetrics() {
    const avgResponseTime =
      this.metrics.responseTime.length > 0
        ? this.metrics.responseTime.reduce((a, b) => a + b) /
          this.metrics.responseTime.length
        : 0

    return {
      ...this.metrics,
      avgResponseTime: Math.round(avgResponseTime),
      errorRate: (this.metrics.errors / this.metrics.requests) * 100,
    }
  }

  // é‡ç½®æŒ‡æ ‡
  reset() {
    this.metrics = {
      requests: 0,
      errors: 0,
      responseTime: [],
      activeConnections: 0,
    }
  }
}

export const monitor = new SimpleMonitor()

// ç›‘æ§è·¯ç”±
app.get("/api/monitor/metrics", (req, res) => {
  res.json(monitor.getMetrics())
})
```

### æ—¥å¿—é…ç½®

```typescript
import winston from "winston"
import DailyRotateFile from "winston-daily-rotate-file"

// æ—¥å¿—è½®è½¬é…ç½®
const createRotatingTransport = (filename: string, level?: string) => {
  return new DailyRotateFile({
    filename: `logs/${filename}-%DATE%.log`,
    datePattern: "YYYY-MM-DD",
    zippedArchive: true,
    maxSize: "20m",
    maxFiles: "14d", // ä¿ç•™14å¤©
    level,
  })
}

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: winston.format.combine(
    winston.format.timestamp({
      format: "YYYY-MM-DD HH:mm:ss",
    }),
    winston.format.errors({ stack: true }),
    winston.format.printf(({ timestamp, level, message, stack, ...meta }) => {
      let log = `${timestamp} [${level.toUpperCase()}]: ${message}`
      if (stack) {
        log += `\n${stack}`
      }
      if (Object.keys(meta).length > 0) {
        log += `\n${JSON.stringify(meta, null, 2)}`
      }
      return log
    })
  ),
  defaultMeta: {
    service: "smart-match-api",
    pid: process.pid,
  },
  transports: [
    // é”™è¯¯æ—¥å¿—
    createRotatingTransport("error", "error"),

    // ç»„åˆæ—¥å¿—
    createRotatingTransport("combined"),

    // æ§åˆ¶å°è¾“å‡º
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      ),
    }),
  ],
})

// ç”Ÿäº§ç¯å¢ƒä¸è¾“å‡ºåˆ°æ§åˆ¶å°
if (process.env.NODE_ENV === "production") {
  logger.remove(logger.transports[2]) // ç§»é™¤æ§åˆ¶å°è¾“å‡º
}

export { logger }
```

### ç³»ç»Ÿç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# monitor.sh - ç³»ç»Ÿç›‘æ§è„šæœ¬

LOG_FILE="/var/log/smart-match-monitor.log"

# è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_services() {
    log "å¼€å§‹æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

    # æ£€æŸ¥ PM2 è¿›ç¨‹
    if ! pm2 status | grep -q "online"; then
        log "ERROR: PM2 æœåŠ¡å¼‚å¸¸"
        # é‡å¯æœåŠ¡
        pm2 restart all
        log "INFO: å·²å°è¯•é‡å¯ PM2 æœåŠ¡"
    fi

    # æ£€æŸ¥ MongoDB
    if ! pgrep mongod > /dev/null; then
        log "ERROR: MongoDB æœªè¿è¡Œ"
        sudo systemctl start mongod
        log "INFO: å·²å¯åŠ¨ MongoDB"
    fi

    # æ£€æŸ¥ Redis
    if ! pgrep redis-server > /dev/null; then
        log "ERROR: Redis æœªè¿è¡Œ"
        sudo systemctl start redis
        log "INFO: å·²å¯åŠ¨ Redis"
    fi

    # æ£€æŸ¥ Nginx
    if ! pgrep nginx > /dev/null; then
        log "ERROR: Nginx æœªè¿è¡Œ"
        sudo systemctl start nginx
        log "INFO: å·²å¯åŠ¨ Nginx"
    fi

    log "æœåŠ¡çŠ¶æ€æ£€æŸ¥å®Œæˆ"
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    DISK_USAGE=$(df / | awk 'NR==2{print $5}' | cut -d'%' -f1)
    if [ $DISK_USAGE -gt 80 ]; then
        log "WARNING: ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: ${DISK_USAGE}%"

        # æ¸…ç†æ—¥å¿—æ–‡ä»¶ (ä¿ç•™æœ€è¿‘7å¤©)
        find /opt/smart-match-system/*/logs -name "*.log" -mtime +7 -delete
        log "INFO: å·²æ¸…ç†è¿‡æœŸæ—¥å¿—æ–‡ä»¶"
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
check_memory() {
    MEMORY_USAGE=$(free | grep Mem | awk '{printf "%.2f", $3/$2 * 100.0}')
    if (( $(echo "$MEMORY_USAGE > 90" | bc -l) )); then
        log "WARNING: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: ${MEMORY_USAGE}%"
    fi
}

# å¥åº·æ£€æŸ¥
health_check() {
    # æ£€æŸ¥ API å¥åº·çŠ¶æ€
    if ! curl -f -s http://localhost:3001/health > /dev/null; then
        log "ERROR: API å¥åº·æ£€æŸ¥å¤±è´¥"
        pm2 restart smart-match-api
        log "INFO: å·²é‡å¯ API æœåŠ¡"
    fi

    # æ£€æŸ¥å‰ç«¯çŠ¶æ€
    if ! curl -f -s http://localhost:3000 > /dev/null; then
        log "ERROR: å‰ç«¯å¥åº·æ£€æŸ¥å¤±è´¥"
        pm2 restart smart-match-web
        log "INFO: å·²é‡å¯å‰ç«¯æœåŠ¡"
    fi
}

# ä¸»å‡½æ•°
main() {
    log "============ å¼€å§‹ç›‘æ§æ£€æŸ¥ ============"
    check_services
    check_disk_space
    check_memory
    health_check
    log "============ ç›‘æ§æ£€æŸ¥å®Œæˆ ============"
}

# è¿è¡Œç›‘æ§
main

# æ·»åŠ åˆ° crontab ä¸­æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
# */5 * * * * /opt/smart-match-system/monitor.sh
```

---

## âš™ï¸ é…ç½®æ–‡ä»¶ç¤ºä¾‹

### Next.js é…ç½®

```javascript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  experimental: {
    appDir: true,
    turbo: {
      rules: {
        "*.svg": {
          loaders: ["@svgr/webpack"],
          as: "*.js",
        },
      },
    },
  },
  images: {
    domains: ["localhost", "your-cdn-domain.com"],
  },
  output: "standalone",
  async rewrites() {
    return [
      {
        source: "/api/:path*",
        destination: `${process.env.NEXT_PUBLIC_API_URL}/api/:path*`,
      },
    ]
  },
}

module.exports = nextConfig
```

### NextUI + Tailwind é…ç½®

```typescript
// tailwind.config.ts
import { nextui } from "@nextui-org/react"

/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
    "./node_modules/@nextui-org/theme/dist/**/*.{js,ts,jsx,tsx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        sans: ["Inter", "PingFang SC", "Microsoft YaHei", "sans-serif"],
      },
    },
  },
  darkMode: "class",
  plugins: [
    nextui({
      themes: {
        light: {
          colors: {
            primary: {
              50: "#eff6ff",
              100: "#dbeafe",
              500: "#3b82f6",
              600: "#2563eb",
              900: "#1e3a8a",
            },
          },
        },
        dark: {
          colors: {
            primary: {
              50: "#1e293b",
              100: "#334155",
              500: "#64748b",
              600: "#475569",
              900: "#0f172a",
            },
          },
        },
      },
    }),
  ],
}
```

### åº”ç”¨ç¨‹åºæ ¹å¸ƒå±€

```typescript
// src/app/layout.tsx
import { Providers } from "./providers"
import { Inter } from "next/font/google"
import "./globals.css"

const inter = Inter({ subsets: ["latin"] })

export const metadata = {
  title: "æ™ºèƒ½å•†å“åŒ¹é…ç³»ç»Ÿ",
  description: "åŸºäºAIçš„å•†å“åŒ¹é…ä¸ä»·æ ¼ç®¡ç†ç³»ç»Ÿ",
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang='zh-CN' suppressHydrationWarning>
      <body className={inter.className}>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

### æä¾›è€…é…ç½®

```typescript
// src/app/providers.tsx
"use client"

import { NextUIProvider } from "@nextui-org/react"
import { ThemeProvider as NextThemesProvider } from "next-themes"
import { SWRConfig } from "swr"

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <NextUIProvider>
      <NextThemesProvider
        attribute='class'
        defaultTheme='light'
        themes={["light", "dark"]}
      >
        <SWRConfig
          value={{
            fetcher: (url: string) => fetch(url).then((res) => res.json()),
            errorRetryCount: 3,
            errorRetryInterval: 5000,
          }}
        >
          {children}
        </SWRConfig>
      </NextThemesProvider>
    </NextUIProvider>
  )
}
```

### API è·¯ç”±ç¤ºä¾‹

```typescript
// src/app/api/matching/route.ts
import { NextRequest, NextResponse } from "next/server"
import { headers } from "next/headers"

export async function POST(request: NextRequest) {
  try {
    const headersList = headers()
    const authorization = headersList.get("authorization")

    if (!authorization) {
      return NextResponse.json(
        { success: false, message: "æœªæˆæƒè®¿é—®" },
        { status: 401 }
      )
    }

    const body = await request.json()

    // è°ƒç”¨åç«¯API
    const response = await fetch(`${process.env.API_BASE_URL}/api/matching`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: authorization,
      },
      body: JSON.stringify(body),
    })

    const data = await response.json()

    return NextResponse.json(data, { status: response.status })
  } catch (error) {
    return NextResponse.json(
      { success: false, message: "æœåŠ¡å™¨é”™è¯¯" },
      { status: 500 }
    )
  }
}
```

---

## ğŸ¨ UI ç»„ä»¶è®¾è®¡

### ä¸»é¢˜åŒ–ç»„ä»¶ç¤ºä¾‹

```typescript
// src/components/ui/matching-card.tsx
"use client"

import {
  Card,
  CardBody,
  CardHeader,
  Progress,
  Chip,
  Button,
  Badge,
} from "@nextui-org/react"
import { cn } from "@/lib/utils"

interface MatchingCardProps {
  item: {
    name: string
    confidence: number
    status: "pending" | "processing" | "completed"
    candidates: number
  }
  className?: string
}

export const MatchingCard: React.FC<MatchingCardProps> = ({
  item,
  className,
}) => {
  const getStatusColor = (status: string) => {
    switch (status) {
      case "completed":
        return "success"
      case "processing":
        return "warning"
      default:
        return "default"
    }
  }

  const getConfidenceColor = (confidence: number) => {
    if (confidence >= 90) return "success"
    if (confidence >= 70) return "warning"
    return "danger"
  }

  return (
    <Card className={cn("w-full", className)}>
      <CardHeader className='flex gap-3'>
        <div className='flex flex-col flex-1'>
          <p className='text-md font-semibold'>{item.name}</p>
          <p className='text-small text-default-500'>
            {item.candidates} ä¸ªå€™é€‰åŒ¹é…
          </p>
        </div>
        <Badge
          content={`${item.confidence}%`}
          color={getConfidenceColor(item.confidence)}
          variant='flat'
        >
          <Chip color={getStatusColor(item.status)} variant='flat' size='sm'>
            {item.status}
          </Chip>
        </Badge>
      </CardHeader>
      <CardBody className='pt-0'>
        <Progress
          size='sm'
          value={item.confidence}
          color={getConfidenceColor(item.confidence)}
          showValueLabel
        />
        <div className='flex gap-2 mt-4'>
          <Button size='sm' variant='flat'>
            æŸ¥çœ‹è¯¦æƒ…
          </Button>
          <Button size='sm' color='primary'>
            ç¡®è®¤åŒ¹é…
          </Button>
        </div>
      </CardBody>
    </Card>
  )
}
```

---

## ğŸ“Š æ•°æ®å¯è§†åŒ–

### åŸºäº Recharts çš„å›¾è¡¨ç»„ä»¶

```typescript
// src/components/charts/matching-trend.tsx
"use client"

import {
  LineChart,
  Line,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  ResponsiveContainer,
} from "recharts"
import { Card, CardBody, CardHeader } from "@nextui-org/react"

interface TrendData {
  date: string
  accuracy: number
  efficiency: number
  volume: number
}

interface MatchingTrendProps {
  data: TrendData[]
  title?: string
}

export const MatchingTrend: React.FC<MatchingTrendProps> = ({
  data,
  title = "åŒ¹é…è¶‹åŠ¿åˆ†æ",
}) => {
  return (
    <Card className='w-full'>
      <CardHeader>
        <h3 className='text-lg font-semibold'>{title}</h3>
      </CardHeader>
      <CardBody>
        <ResponsiveContainer width='100%' height={400}>
          <LineChart data={data}>
            <CartesianGrid strokeDasharray='3 3' />
            <XAxis dataKey='date' tick={{ fontSize: 12 }} />
            <YAxis tick={{ fontSize: 12 }} />
            <Tooltip
              contentStyle={{
                backgroundColor: "rgba(255, 255, 255, 0.95)",
                border: "1px solid #e2e8f0",
                borderRadius: "8px",
              }}
            />
            <Line
              type='monotone'
              dataKey='accuracy'
              stroke='#10b981'
              strokeWidth={2}
              name='å‡†ç¡®ç‡ (%)'
            />
            <Line
              type='monotone'
              dataKey='efficiency'
              stroke='#3b82f6'
              strokeWidth={2}
              name='æ•ˆç‡ (%)'
            />
          </LineChart>
        </ResponsiveContainer>
      </CardBody>
    </Card>
  )
}
```

---

è¿™ä¸ªæ›´æ–°åçš„æŠ€æœ¯æ¶æ„æ–‡æ¡£é‡‡ç”¨äº†ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆï¼š

- **Node.js 18**: ç¨³å®šçš„ LTS ç‰ˆæœ¬ï¼Œæ€§èƒ½ä¼˜å¼‚
- **Next.js 14**: æœ€æ–°çš„å…¨æ ˆ React æ¡†æ¶ï¼Œæ”¯æŒ App Router
- **NextUI**: ç°ä»£åŒ–çš„ UI ç»„ä»¶åº“ï¼ŒåŸºäº React Aria å’Œ Tailwind CSS
- **Zustand + SWR**: è½»é‡çº§çŠ¶æ€ç®¡ç†å’Œæ•°æ®è·å–
- **Tailwind CSS**: åŸå­åŒ– CSS æ¡†æ¶

æ¶æ„è®¾è®¡æ³¨é‡å¯æ‰©å±•æ€§ã€é«˜æ€§èƒ½å’Œé«˜å¯ç”¨æ€§ï¼Œèƒ½å¤Ÿæ”¯æ’‘æ™ºèƒ½åŒ¹é…ç³»ç»Ÿçš„ä¸šåŠ¡éœ€æ±‚ã€‚
